<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vercel Payment Plan Workflow Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section { 
            margin: 30px 0; 
            padding: 20px; 
            border: 2px solid #ddd; 
            border-radius: 8px;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #007bff; font-weight: bold; }
        button { 
            padding: 12px 24px; 
            margin: 10px 5px; 
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        #output { 
            background: #f8f9fa; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .step {
            background: #e9ecef;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #6c757d;
        }
        .step.active {
            background: #d4edda;
            border-left-color: #28a745;
        }
        .step.error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Vercel Payment Plan Workflow Test</h1>
        <p class="info">Complete browser testing of payment plan functionality on: <strong>https://ra1dashboard.vercel.app</strong></p>
        
        <div class="test-section">
            <h2>üîç Test Configuration</h2>
            <div id="config">
                <p><strong>Target URL:</strong> https://ra1dashboard.vercel.app</p>
                <p><strong>Test Parent ID:</strong> j575pe13bk6q79y02vst3qa4zh7m5w0h</p>
                <p><strong>Test Plan:</strong> $1200 total, 4 installments of $300 each</p>
            </div>
        </div>

        <div class="test-section">
            <h2>üìã Test Workflow Steps</h2>
            <div class="step" id="step1">
                <strong>Step 1:</strong> Health Check - Verify Vercel deployment is accessible
            </div>
            <div class="step" id="step2">
                <strong>Step 2:</strong> Create Payment Plan - Test API endpoint functionality
            </div>
            <div class="step" id="step3">
                <strong>Step 3:</strong> Verify Redirect Target - Check payment detail page accessibility
            </div>
            <div class="step" id="step4">
                <strong>Step 4:</strong> Validate Progress Tracking - Confirm first payment marked as PAID
            </div>
            <div class="step" id="step5">
                <strong>Step 5:</strong> Test Complete Workflow - Simulate browser redirect behavior
            </div>
        </div>

        <div class="test-section">
            <h2>üéØ Test Controls</h2>
            <button class="btn-primary" onclick="runCompleteTest()">üöÄ Run Complete Workflow Test</button>
            <button class="btn-success" onclick="testHealthCheck()">‚ù§Ô∏è Health Check</button>
            <button class="btn-warning" onclick="openVercelApp()">üåê Open Vercel App</button>
        </div>

        <div id="output">
            <h3>üìä Test Results</h3>
            <div id="results">Ready to run tests...</div>
        </div>
    </div>

    <script>
        const VERCEL_URL = 'https://ra1dashboard.vercel.app';
        const TEST_PARENT_ID = 'j575pe13bk6q79y02vst3qa4zh7m5w0h';
        
        let currentPaymentId = null;
        
        function updateStep(stepId, status, message) {
            const step = document.getElementById(stepId);
            step.className = `step ${status}`;
            if (message) {
                step.innerHTML += `<br><small>${message}</small>`;
            }
        }
        
        function logResult(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            results.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            results.scrollTop = results.scrollHeight;
        }
        
        async function testHealthCheck() {
            logResult('üîç Testing Vercel health endpoint...');
            updateStep('step1', 'active', 'Checking health...');
            
            try {
                const response = await fetch(`${VERCEL_URL}/api/health`);
                const data = await response.json();
                
                if (response.ok && data.status === 'healthy') {
                    updateStep('step1', 'active', '‚úÖ Health check passed');
                    logResult(`‚úÖ Health Check: ${data.status} - Database: ${data.database}`, 'success');
                    return true;
                } else {
                    updateStep('step1', 'error', '‚ùå Health check failed');
                    logResult('‚ùå Health check failed', 'error');
                    return false;
                }
            } catch (error) {
                updateStep('step1', 'error', `‚ùå Error: ${error.message}`);
                logResult(`‚ùå Health check error: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function createPaymentPlan() {
            logResult('üí≥ Creating payment plan on Vercel...');
            updateStep('step2', 'active', 'Creating payment plan...');
            
            const planData = {
                parentId: TEST_PARENT_ID,
                type: "monthly",
                totalAmount: 1200,
                installments: 4,
                installmentAmount: 300,
                startDate: "2025-03-01",
                description: "VERCEL BROWSER TEST - Complete Workflow Verification"
            };
            
            try {
                const response = await fetch(`${VERCEL_URL}/api/payment-plans`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(planData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    currentPaymentId = result.paymentIds[0];
                    updateStep('step2', 'active', '‚úÖ Payment plan created successfully');
                    logResult(`‚úÖ Payment Plan Created: ${result.paymentPlanId}`, 'success');
                    logResult(`üìã Main Payment ID: ${currentPaymentId}`, 'info');
                    logResult(`üìä Progress: ${result.progressData.paidInstallments}/${result.progressData.totalInstallments} paid (${result.progressData.progressPercentage}%)`, 'success');
                    return result;
                } else {
                    updateStep('step2', 'error', '‚ùå Payment plan creation failed');
                    logResult(`‚ùå Payment plan creation failed: ${JSON.stringify(result)}`, 'error');
                    return null;
                }
            } catch (error) {
                updateStep('step2', 'error', `‚ùå Error: ${error.message}`);
                logResult(`‚ùå Payment plan creation error: ${error.message}`, 'error');
                return null;
            }
        }
        
        async function testRedirectTarget() {
            if (!currentPaymentId) {
                logResult('‚ùå No payment ID available for redirect test', 'error');
                return false;
            }
            
            logResult(`üîó Testing redirect target: /payments/${currentPaymentId}`);
            updateStep('step3', 'active', 'Testing redirect target...');
            
            try {
                // Test if the payment detail page is accessible
                const pageResponse = await fetch(`${VERCEL_URL}/payments/${currentPaymentId}`);
                const pageAccessible = pageResponse.ok;
                
                // Test the payment data API
                const apiResponse = await fetch(`${VERCEL_URL}/api/payments/${currentPaymentId}`);
                const paymentData = await apiResponse.json();
                
                if (pageAccessible && apiResponse.ok) {
                    updateStep('step3', 'active', '‚úÖ Redirect target accessible');
                    logResult(`‚úÖ Payment detail page accessible: /payments/${currentPaymentId}`, 'success');
                    logResult(`üìã Payment data loaded: ${paymentData.parent?.name || 'Unknown parent'}`, 'success');
                    return true;
                } else {
                    updateStep('step3', 'error', '‚ùå Redirect target not accessible');
                    logResult('‚ùå Payment detail page not accessible', 'error');
                    return false;
                }
            } catch (error) {
                updateStep('step3', 'error', `‚ùå Error: ${error.message}`);
                logResult(`‚ùå Redirect test error: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function validateProgressTracking() {
            if (!currentPaymentId) {
                logResult('‚ùå No payment ID available for progress test', 'error');
                return false;
            }
            
            logResult('üìä Validating progress tracking system...');
            updateStep('step4', 'active', 'Checking progress tracking...');
            
            try {
                const response = await fetch(`${VERCEL_URL}/api/payments/${currentPaymentId}/progress`);
                const progressData = await response.json();
                
                if (response.ok) {
                    const firstInstallmentPaid = progressData.paidInstallments > 0;
                    const correctProgress = progressData.progressPercentage === 25; // 1/4 = 25%
                    
                    if (firstInstallmentPaid && correctProgress) {
                        updateStep('step4', 'active', '‚úÖ Progress tracking working correctly');
                        logResult(`‚úÖ First installment marked as PAID: ${progressData.paidInstallments}/${progressData.totalInstallments}`, 'success');
                        logResult(`üìä Progress: ${progressData.progressPercentage}% complete`, 'success');
                        logResult(`üí∞ Amount paid: $${progressData.paidAmount} of $${progressData.totalAmount}`, 'success');
                        return true;
                    } else {
                        updateStep('step4', 'error', '‚ùå Progress tracking incorrect');
                        logResult(`‚ùå Progress tracking issue: Paid=${progressData.paidInstallments}, Progress=${progressData.progressPercentage}%`, 'error');
                        return false;
                    }
                } else {
                    updateStep('step4', 'error', '‚ùå Progress API failed');
                    logResult('‚ùå Progress tracking API failed', 'error');
                    return false;
                }
            } catch (error) {
                updateStep('step4', 'error', `‚ùå Error: ${error.message}`);
                logResult(`‚ùå Progress tracking error: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function simulateWorkflow() {
            logResult('üé≠ Simulating complete browser workflow...');
            updateStep('step5', 'active', 'Simulating workflow...');
            
            if (!currentPaymentId) {
                updateStep('step5', 'error', '‚ùå No payment ID for workflow simulation');
                logResult('‚ùå Cannot simulate workflow without payment ID', 'error');
                return false;
            }
            
            // Simulate the complete workflow
            logResult('1Ô∏è‚É£ User fills out payment plan form', 'info');
            logResult('2Ô∏è‚É£ User clicks "Create Payment Plan" button', 'info');
            logResult('3Ô∏è‚É£ API creates payment plan and returns payment ID', 'success');
            logResult(`4Ô∏è‚É£ Frontend redirects to: /payments/${currentPaymentId}`, 'info');
            logResult('5Ô∏è‚É£ Payment detail page loads with tracking system', 'success');
            logResult('6Ô∏è‚É£ First installment shows as PAID ‚úÖ', 'success');
            logResult('7Ô∏è‚É£ Progress bar shows 25% complete', 'success');
            
            // Open the actual payment detail page
            const paymentUrl = `${VERCEL_URL}/payments/${currentPaymentId}`;
            logResult(`üåê Opening payment detail page: ${paymentUrl}`, 'info');
            
            // Create a link for manual verification
            const results = document.getElementById('results');
            results.innerHTML += `
                <div class="success">
                    <strong>üéØ WORKFLOW COMPLETE!</strong><br>
                    <a href="${paymentUrl}" target="_blank" style="color: #007bff; text-decoration: none;">
                        üîó Click here to view the payment detail page: ${paymentUrl}
                    </a>
                </div>
            `;
            
            updateStep('step5', 'active', '‚úÖ Workflow simulation complete');
            return true;
        }
        
        async function runCompleteTest() {
            logResult('üöÄ Starting complete payment plan workflow test...', 'success');
            
            // Reset all steps
            ['step1', 'step2', 'step3', 'step4', 'step5'].forEach(id => {
                document.getElementById(id).className = 'step';
            });
            
            document.getElementById('results').innerHTML = '<h4>üß™ Running Complete Test Suite...</h4>';
            
            // Run all tests in sequence
            const healthOk = await testHealthCheck();
            if (!healthOk) return;
            
            await new Promise(resolve => setTimeout(resolve, 1000)); // Brief pause
            
            const paymentPlan = await createPaymentPlan();
            if (!paymentPlan) return;
            
            await new Promise(resolve => setTimeout(resolve, 1000)); // Brief pause
            
            const redirectOk = await testRedirectTarget();
            if (!redirectOk) return;
            
            await new Promise(resolve => setTimeout(resolve, 1000)); // Brief pause
            
            const progressOk = await validateProgressTracking();
            if (!progressOk) return;
            
            await new Promise(resolve => setTimeout(resolve, 1000)); // Brief pause
            
            const workflowOk = await simulateWorkflow();
            
            if (workflowOk) {
                logResult('üéâ ALL TESTS PASSED! Payment plan workflow is fully functional on Vercel!', 'success');
            }
        }
        
        function openVercelApp() {
            logResult('üåê Opening Vercel application...', 'info');
            window.open(`${VERCEL_URL}/payment-plans/new`, '_blank');
            window.open(`${VERCEL_URL}/payments`, '_blank');
        }
        
        // Auto-run health check on page load
        window.onload = function() {
            logResult('üèÅ Browser test page loaded. Ready to test Vercel deployment!', 'info');
        };
    </script>
</body>
</html> 